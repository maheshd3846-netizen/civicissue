<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicConnect - Jharkhand Civic Issue Reporting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --light: #f5f5f5;
            --dark: #333;
            --gray: #757575;
            --danger: #d32f2f;
            --success: #388e3c;
            --warning: #f57c00;
            --info: #1976d2;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid white;
            color: white;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Main Content */
        main {
            padding: 2rem 0;
            min-height: 80vh;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--gray);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .location-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .location-info {
            display: flex;
            justify-content: between;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .location-coordinates {
            font-family: monospace;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .alert-success { background: #e8f5e9; color: #388e3c; border: 1px solid #c8e6c9; }
        .alert-error { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .alert-warning { background: #fff3e0; color: #f57c00; border: 1px solid #ffe0b2; }
        .alert-info { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }

        .hidden {
            display: none;
        }

        .issue-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .issue-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .status-reported { background: #e3f2fd; color: #1976d2; }
        .status-acknowledged { background: #fff3e0; color: #f57c00; }
        .status-in_progress { background: #e8f5e9; color: #388e3c; }
        .status-resolved { background: #f5f5f5; color: #757575; }

        .map-container {
            height: 400px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .location-marker {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .location-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-city fa-2x"></i>
                    <h1>CivicConnect</h1>
                </div>
                <div class="auth-section">
                    <span id="userInfo"></span>
                    <button class="btn btn-outline" onclick="logout()" id="logoutBtn" style="display: none;">Logout</button>
                    <button class="btn btn-primary" onclick="showLogin()" id="loginBtn">Login</button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Login Section -->
            <div id="loginSection" class="card">
                <h2>Login to CivicConnect</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required value="rahul@example.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required value="password123">
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <p style="margin-top: 1rem;">
                        Don't have an account? 
                        <a href="#" onclick="showRegister()">Register here</a>
                    </p>
                </form>
            </div>

            <!-- Register Section -->
            <div id="registerSection" class="card hidden">
                <h2>Create Account</h2>
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regName">Full Name</label>
                        <input type="text" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="regPhone">Phone</label>
                        <input type="tel" id="regPhone" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Register</button>
                    <p style="margin-top: 1rem;">
                        Already have an account? 
                        <a href="#" onclick="showLogin()">Login here</a>
                    </p>
                </form>
            </div>

            <!-- Main App Section -->
            <div id="appSection" class="hidden">
                <!-- Location Detection -->
                <div class="card">
                    <div class="location-section">
                        <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                        <div class="location-info">
                            <div>
                                <strong>Address:</strong> 
                                <span id="currentAddress">Detecting your location...</span>
                            </div>
                            <div class="location-coordinates">
                                Lat: <span id="currentLat">--</span>, Lng: <span id="currentLng">--</span>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-small" onclick="getCurrentLocation()">
                                <i class="fas fa-sync-alt"></i> Refresh Location
                            </button>
                            <button class="btn btn-outline btn-small" onclick="useManualLocation()">
                                <i class="fas fa-edit"></i> Enter Manually
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Issue Form -->
                <div class="card">
                    <h2>Report a Civic Issue</h2>
                    <form id="reportForm">
                        <div class="form-group">
                            <label for="issueCategory">Issue Type</label>
                            <select id="issueCategory" required>
                                <option value="">Select issue type</option>
                                <option value="pothole">Pothole</option>
                                <option value="streetlight">Street Light</option>
                                <option value="trash">Trash Overflow</option>
                                <option value="water">Water Issue</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="issueTitle">Title</label>
                            <input type="text" id="issueTitle" placeholder="Brief description" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="issueDescription">Description</label>
                            <textarea id="issueDescription" placeholder="Detailed description" required></textarea>
                        </div>
                        
                        <div class="form-group" id="manualLocationGroup" style="display: none;">
                            <label for="issueLocation">Location Address</label>
                            <input type="text" id="issueLocation" placeholder="Enter street address">
                        </div>
                        
                        <div class="form-group">
                            <label for="issuePriority">Priority</label>
                            <select id="issuePriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Upload Photo (Optional)</label>
                            <input type="file" id="issuePhoto" accept="image/*">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            Submit Report
                        </button>
                    </form>
                </div>

                <!-- Map -->
                <div class="map-container">
                    <div id="map"></div>
                    <div class="location-marker">
                        <button class="btn btn-primary btn-small" onclick="centerMapOnUser()">
                            <i class="fas fa-location-arrow"></i> My Location
                        </button>
                    </div>
                </div>

                <!-- Issues List -->
              
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let authToken = localStorage.getItem('token');
        let map;
        let userLocation = null;
        let userMarker = null;
        let isManualLocation = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupEventListeners();
            checkAuthStatus();
            getCurrentLocation(); // Auto-detect location on page load
        });

        // Initialize map
        function initMap() {
            map = L.map('map').setView([23.3441, 85.3096], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Get current location using Geolocation API
        function getCurrentLocation() {
            showAlert('Detecting your location...', 'info');
            
            if (!navigator.geolocation) {
                showAlert('Geolocation is not supported by this browser.', 'error');
                useManualLocation();
                return;
            }

            // Show loading state
            document.getElementById('currentAddress').innerHTML = '<div class="spinner"></div> Detecting...';

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    userLocation = { lat, lng };
                    
                    // Update UI
                    document.getElementById('currentLat').textContent = lat.toFixed(6);
                    document.getElementById('currentLng').textContent = lng.toFixed(6);
                    
                    // Get address from coordinates (reverse geocoding)
                    try {
                        const address = await getAddressFromCoords(lat, lng);
                        document.getElementById('currentAddress').textContent = address;
                        document.getElementById('issueLocation').value = address;
                    } catch (error) {
                        document.getElementById('currentAddress').textContent = 'Address not available';
                        document.getElementById('issueLocation').value = `Near coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                    
                    // Update map
                    updateUserLocationOnMap(lat, lng);
                    showAlert('Location detected successfully!', 'success');
                    isManualLocation = false;
                    document.getElementById('manualLocationGroup').style.display = 'none';
                    
                },
                function(error) {
                    console.error('Error getting location:', error);
                    let errorMessage = 'Unable to detect your location. ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Please allow location access to use automatic detection.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred.';
                    }
                    
                    showAlert(errorMessage, 'error');
                    document.getElementById('currentAddress').textContent = 'Location detection failed';
                    useManualLocation();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Get address from coordinates using OpenStreetMap Nominatim
        async function getAddressFromCoords(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    // Build a readable address string
                    const addressParts = [];
                    if (address.road) addressParts.push(address.road);
                    if (address.suburb) addressParts.push(address.suburb);
                    if (address.city || address.town || address.village) {
                        addressParts.push(address.city || address.town || address.village);
                    }
                    if (address.state) addressParts.push(address.state);
                    
                    return addressParts.join(', ') || 'Address not available';
                }
                return 'Address not available';
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return 'Address not available';
            }
        }

        // Update user location on map
        function updateUserLocationOnMap(lat, lng) {
            // Remove existing marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Add new marker
            userMarker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup('Your current location')
                .openPopup();
            
            // Center map on user location
            map.setView([lat, lng], 15);
        }

        // Center map on user location
        function centerMapOnUser() {
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 15);
                if (userMarker) {
                    userMarker.openPopup();
                }
            } else {
                showAlert('No location data available. Please detect your location first.', 'warning');
            }
        }

        // Switch to manual location input
        function useManualLocation() {
            isManualLocation = true;
            document.getElementById('manualLocationGroup').style.display = 'block';
            document.getElementById('currentAddress').textContent = 'Manual location entry';
            document.getElementById('issueLocation').value = '';
            document.getElementById('issueLocation').placeholder = 'Enter street address, landmark, or area';
            showAlert('Please enter the location manually.', 'info');
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await login();
            });

            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await register();
            });

            document.getElementById('reportForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitIssue();
            });

            // Auto-detect location when category is selected
            document.getElementById('issueCategory').addEventListener('change', function() {
                if (!userLocation && !isManualLocation) {
                    getCurrentLocation();
                }
            });
        }

        // Check authentication status
        async function checkAuthStatus() {
            if (authToken) {
                try {
                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        currentUser = data.data;
                        showApp();
                    } else {
                        logout();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    logout();
                }
            }
        }

        // User registration
        async function register() {
            const formData = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                phone: document.getElementById('regPhone').value
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Registration successful! Please login.', 'success');
                    showLogin();
                    document.getElementById('registerForm').reset();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Registration failed. Please try again.', 'error');
            }
        }

        // User login
        async function login() {
            const formData = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.data.token;
                    localStorage.setItem('token', authToken);
                    currentUser = data.data;
                    showApp();
                    showAlert('Login successful!', 'success');
                    loadIssues();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                showAlert('Login failed. Please check your connection.', 'error');
            }
        }

        // Submit new issue
        async function submitIssue() {
            if (!currentUser) {
                showAlert('Please login to report issues', 'error');
                return;
            }

            // Validate location
            const locationAddress = document.getElementById('issueLocation').value;
            if (!locationAddress) {
                showAlert('Please provide a location for the issue.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('title', document.getElementById('issueTitle').value);
            formData.append('description', document.getElementById('issueDescription').value);
            formData.append('category', document.getElementById('issueCategory').value);
            formData.append('priority', document.getElementById('issuePriority').value);
            formData.append('location[address]', locationAddress);
            
            // Use detected coordinates or default to Ranchi coordinates
            if (userLocation && !isManualLocation) {
                formData.append('location[coordinates][lat]', userLocation.lat);
                formData.append('location[coordinates][lng]', userLocation.lng);
            } else {
                // Default to Ranchi coordinates if no location detected
                formData.append('location[coordinates][lat]', '23.3441');
                formData.append('location[coordinates][lng]', '85.3096');
            }
            
            const photoInput = document.getElementById('issuePhoto');
            if (photoInput.files[0]) {
                formData.append('images', photoInput.files[0]);
            }

            try {
                // Show loading state
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerHTML = '<div class="spinner"></div> Submitting...';
                submitBtn.disabled = true;

                const response = await fetch(`${API_BASE}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                // Reset button
                submitBtn.innerHTML = 'Submit Report';
                submitBtn.disabled = false;

                if (response.ok) {
                    showAlert('Issue reported successfully!', 'success');
                    document.getElementById('reportForm').reset();
                    loadIssues();
                } else {
                    showAlert(data.message, 'error');
                }
            } catch (error) {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerHTML = 'Submit Report';
                submitBtn.disabled = false;
                showAlert('Failed to submit issue. Please try again.', 'error');
            }
        }

        // Load all issues
        async function loadIssues() {
            try {
                const response = await fetch(`${API_BASE}/issues`);
                const data = await response.json();

                if (response.ok) {
                    displayIssues(data.data);
                    updateMapWithIssues(data.data);
                }
            } catch (error) {
                console.error('Failed to load issues:', error);
            }
        }

        // Display issues
        function displayIssues(issues) {
            const issuesList = document.getElementById('issuesList');
            issuesList.innerHTML = '';

            if (issues.length === 0) {
                issuesList.innerHTML = '<p>No issues reported yet.</p>';
                return;
            }

            issues.forEach(issue => {
                const issueElement = document.createElement('div');
                issueElement.className = 'issue-card';
                
                issueElement.innerHTML = `
                    <div class="issue-meta">
                        <span class="status-badge status-${issue.status}">${issue.status.replace('_', ' ')}</span>
                        <span>${new Date(issue.createdAt).toLocaleDateString()}</span>
                    </div>
                    <h3>${issue.title}</h3>
                    <p>${issue.description}</p>
                    <p><strong>Location:</strong> ${issue.location?.address}</p>
                    <p><strong>Category:</strong> ${issue.category} | <strong>Priority:</strong> ${issue.priority}</p>
                    <p><strong>Reported by:</strong> ${issue.reportedBy?.name || 'Anonymous'}</p>
                `;

                issuesList.appendChild(issueElement);
            });
        }

        // Update map with issues
        function updateMapWithIssues(issues) {
            // Clear existing issue markers (keep user marker)
            map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer !== userMarker) {
                    map.removeLayer(layer);
                }
            });

            const iconColors = {
                pothole: 'red',
                streetlight: 'orange',
                trash: 'green',
                water: 'blue',
                other: 'gray'
            };

            issues.forEach(issue => {
                if (issue.location?.coordinates) {
                    const icon = L.divIcon({
                        html: `<i class="fas fa-map-marker-alt" style="color: ${iconColors[issue.category] || 'gray'}; font-size: 24px;"></i>`,
                        iconSize: [24, 24]
                    });

                    L.marker([issue.location.coordinates.lat, issue.location.coordinates.lng], { icon })
                        .addTo(map)
                        .bindPopup(`
                            <b>${issue.title}</b><br>
                            <small>${issue.category} • ${issue.status}</small><br>
                            ${issue.description}
                        `);
                }
            });
        }

        // Navigation functions
        function showLogin() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('registerSection').classList.add('hidden');
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('registerSection').classList.remove('hidden');
            document.getElementById('appSection').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('registerSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('loginBtn').style.display = 'none';
            
            document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name}`;
            loadIssues();
        }

        function logout() {
            localStorage.removeItem('token');
            authToken = null;
            currentUser = null;
            showLogin();
            showAlert('Logged out successfully', 'success');
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Auto-detect location when app loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (document.getElementById('appSection').classList.contains('hidden')) {
                    getCurrentLocation();
                }
            }, 1000);
        });
    </script>
</body>
</html>